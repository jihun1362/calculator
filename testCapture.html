<!DOCTYPE html>
<html lang="en">
  <style>
      body > *{
        box-sizing: border-box;
      }
      
      body {
        text-align: center;
        /* background-color: #57F2EB; */
        margin:0px 40px;
      }
      p{
        color: #777777;
      }
      
      button{
        width: 100px;
        height: 45px;
        background-color: #6464D9;
        border: 1px solid white;
        color:white;
      
        margin: 25px 0px;
      }
      
      .bg-white{
        background-color: white;
      }
      #selector-box{
        margin: 20px 0px;
      }
  </style>
  <head>
  <script>
    //  philipwalton.com/articles/the-google-analytics-setup-i-use-on-every-site-i-build
    window.ga = window.ga || function() {
      (ga.q = ga.q || []).push(arguments);
    };
    ga('create', 'UA-33848682-1', 'auto');
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview');
  </script>

  <meta charset="utf-8">
  <meta name="description" content="examples of HTML, CSS and JavaScript.">
  <link rel='stylesheet' type='text/css' href='./css/styles.css'>
  <base target="_blank">
  <title>Simple Web Cam</title>
  </head>
  <header>
    <h1>Simple Web Cam</h1>
  </header>
  <body>
  <div class="bg-white">
    <div id="selector-box">
      <div class="select">
        <label for="audioSource">Audio source: </label><select id="audioSource"></select>
      </div>

      <div class="select">
        <label for="videoSource">Video source: </label><select id="videoSource"></select>
      </div>
    </div>

    <video autoplay muted laysinline></video>
    <canvas style="display:none;"></canvas>
    <div>
      <button>Capture</button>
    </div>
    <img id="steel-shot" src = "">
  </div>
    <!--     
    <script async src="js/browser.js"></script>
    <script async src="js/media.js"></script>
    <script async src="js/event.js"></script> 
    -->
    <script>

      // Opera 8.0+
      var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
      
      // Firefox 1.0+
      var isFirefox = typeof InstallTrigger !== 'undefined';
      
      // Safari 3.0+ "[object HTMLElementConstructor]" 
      var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && safari.pushNotification));
      
      // Internet Explorer 6-11
      var isIE = /*@cc_on!@*/false || !!document.documentMode;
      
      // Edge 20+
      var isEdge = !isIE && !!window.StyleMedia;
      
      // Chrome 1 - 79
      var isChrome = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime);
      
      // Edge (based on chromium) detection
      var isEdgeChromium = isChrome && (navigator.userAgent.indexOf("Edg") != -1);
      
      // Blink engine detection
      var isBlink = (isChrome || isOpera) && !!window.CSS;

      captureVideo = () =>{
        console.log('captureSteelShot');
        captureSteelShot();
        renderImg();
      }
      
      document.querySelector("video").addEventListener('click', captureVideo, false);
      document.querySelector("button").addEventListener('click', captureVideo, false);
      
      const videoElement = document.querySelector('video');
      const audioSelect = document.querySelector('select#audioSource');
      const videoSelect = document.querySelector('select#videoSource');
      const selectors = [audioInputSelect, videoSelect];
      
      audioSelect.onchange = getStream;
      videoSelect.onchange = getStream;
      
      getStream().then(getDevices).then(gotDevices);
      
      function getDevices() {
        // AFAICT in Safari this only gets default devices until gUM is called :/
        return navigator.mediaDevices.enumerateDevices();
      }
      
      function gotDevices(deviceInfos) {
        window.deviceInfos = deviceInfos; // make available to console
        console.log('Available input and output devices:', deviceInfos);
       const values = selectors.map(select => select.value);
        selectors.forEach(select => {
          while (select.firstChild) {
            select.removeChild(select.firstChild);
          }
        });
        for (const deviceInfo of deviceInfos) {
          const option = document.createElement('option');
          option.value = deviceInfo.deviceId;
          if (deviceInfo.kind === 'audioinput') {
            option.text = deviceInfo.label || `Microphone ${audioSelect.length + 1}`;
            audioSelect.appendChild(option);
          } else if (deviceInfo.kind === 'videoinput') {
            option.text = deviceInfo.label || `Camera ${videoSelect.length + 1}`;
            videoSelect.appendChild(option);
          }
        }
      }
      
      function getStream() {
        if (window.stream) {
          window.stream.getTracks().forEach(track => {
            track.stop();
          });
        }
        const audioSource = audioSelect.value;
        const videoSource = videoSelect.value;
          console.log(audioSource);
          console.log(videoSource);
        const constraints = {
          audio: false,
          video: video: {deviceId: videoSource ? {exact: videoSource} : undefined}
        };
          console.log(constraints);
        return navigator.mediaDevices.getUserMedia(constraints).
          then(gotStream).catch(handleError);
      }
      
      function gotStream(stream) {
        window.stream = stream; 
          console.log('stream1:'+stream);
          
        audioSelect.selectedIndex = [...audioSelect.options].
          findIndex(option => option.text === stream.getAudioTracks()[0].label);
        videoSelect.selectedIndex = [...videoSelect.options].
          findIndex(option => option.text === stream.getVideoTracks()[0].label);
          console.log('stream2:'+stream);
        videoElement.srcObject = stream;
      }
      
      // Not showing vendor prefixes or code that works cross-browser.
      var video = document.querySelector('video');
      var canvas = document.querySelector('canvas');
      var ctx = canvas.getContext('2d');
      var localMediaStream = null;
      var steelShotData = null;
      
      function captureSteelShot() {
        if (localMediaStream) {
          const videoRec = video.getBoundingClientRect()
      
          canvas.width = videoRec.width;
          canvas.height = videoRec.height;
      
          ctx.drawImage(video, 0, 0);
          if(isChrome)
            steelShotData = canvas.toDataURL('image/webp')
          else
            steelShotData = canvas.toDataURL('image/png')
        }
      }
      
      function renderImg(){
        const tagIMG = document.getElementById("steel-shot")
        console.log(tagIMG);
        tagIMG.src = steelShotData;
      }
      
      navigator.mediaDevices.getUserMedia({video:true})
      .then(function(stream) {
        video.srcObject=stream;
        localMediaStream = stream;
      })
      .catch(function(err) {
        console.log("Fail getUserMedia");
      });
      
      function handleError(error) {
        console.error('Error: ', error);
      }
      
    </script> 
  </body>
  <footer>
    <p>Hello!<br>made by Dev. kiju2<br>
    LICENSE <a href="./LICENSE">MIT License</a><br>
    and My blog is <a href="https://2kiju.tistory.com/">here</a>
  </p>
  </footer>
</html>
